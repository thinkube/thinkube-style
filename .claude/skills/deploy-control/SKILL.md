---
name: deploy-control
description: Deploy thinkube-control Copier template. MUST BE USED when user says "deploy", "let's deploy", "deployment", or when build completes and next step is deployment. Proactively enforces correct deployment workflow.
tools: Bash, Read
model: inherit
---

# Deploy thinkube-control

You are deploying the **thinkube-control Copier template** to dev environment.

## CRITICAL: Template Architecture

**thinkube-control is a Copier template, NOT a regular application:**

- **GitHub repository** = Copier TEMPLATE (what you edit directly)
- **Gitea repository** = Instantiated code (auto-generated by Copier)
- **YOU NEVER MANUALLY PUSH TO GITEA** ❌
- **Ansible playbook handles EVERYTHING** ✅

## Deployment Workflow (Execute in Order)

### Step 1: Build Frontend

```bash
cd /home/alexmc/thinkube-control/frontend && npm run build
```

**If build fails:** Stop immediately, show error, let user fix.

### Step 2: Commit and Push to GitHub

```bash
cd /home/alexmc/thinkube-control
git add -A
git commit -m "Deploy: [brief description of changes]"
git push origin main
```

**This pushes to GitHub template repository** (NOT Gitea).

### Step 3: Run Ansible Deployment

```bash
cd /tmp/thinkube-installer
./scripts/run_ansible.sh ansible/40_thinkube/core/thinkube-control/12_deploy_dev.yaml
```

**What this playbook does:**
1. Pulls latest code from GitHub template
2. Runs Copier to transform template
3. Generates instantiated code in `/shared-code`
4. Pushes to Gitea (triggers webhook)
5. Gitea webhook → Argo Workflow (builds container image)
6. Harbor webhook → ArgoCD (deploys to Kubernetes)

### Step 4: Show Monitoring Instructions

Tell the user:

```
✅ Deployment initiated successfully!

Monitor the deployment:
- ArgoCD UI: https://argocd.cmxela.com (check thinkube-control app)
- Harbor: https://registry.cmxela.com (check for new image)
- kubectl: kubectl get pods -n thinkube-control -w

⚠️ Note: Cannot use control.cmxela.com/cicd to monitor thinkube-control
deployment (circular dependency - control IS the app being deployed).

Build typically takes 3-5 minutes.
```

## Deployment Playbook Selection

- **Use `12_deploy_dev.yaml`** for code-only changes (preserves databases) ✅
- **Use `12_deploy.yaml`** ONLY for database schema changes (⚠️ DESTROYS ALL DATA)
- For React migration, ALWAYS use `12_deploy_dev.yaml`

## Common Mistakes to Avoid

❌ **DO NOT** manually push to Gitea
❌ **DO NOT** suggest "commit and push to Gitea"
❌ **DO NOT** mention control.cmxela.com/cicd for monitoring
❌ **DO NOT** run `npm run dev` for deployment (that's local development)
❌ **DO NOT** skip the build step

✅ **ALWAYS** run build first
✅ **ALWAYS** push to GitHub (template repo)
✅ **ALWAYS** use Ansible playbook
✅ **ALWAYS** mention ArgoCD/Harbor/kubectl for monitoring

## Error Handling

If any step fails:
1. Show the complete error output to the user
2. DO NOT continue to subsequent steps
3. Let user decide how to proceed
4. Do not guess or make assumptions

## Environment

- No ANSIBLE_BECOME_PASSWORD needed (SSH keys configured)
- Working directory for control: /home/alexmc/thinkube-control
- Installer location: /tmp/thinkube-installer
